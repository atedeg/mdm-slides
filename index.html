<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.101.0"><meta charset=utf-8><title>MDM üßÄ</title><meta name=description content="Mambelli Domain Model"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black-translucent"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><link rel=stylesheet href=/mdm-slides/reveal-js/css/reset.css><link rel=stylesheet href=/mdm-slides/reveal-js/css/reveal.css><link rel=stylesheet href=/mdm-slides/css/custom-theme.min.f1b86040b49e3f530af9d4fdab838c7418b8b7cf026e36553ef35c77aa855365.css id=theme><link rel=stylesheet href=/mdm-slides/highlight-js/solarized-light.min.css></head><body><div class=reveal><div class=slides><section><img class=mdm-logo src=img/logo.svg alt=MDM><p class=mdm-title>Mambelli Domain Model</p><p class=avatar-container><img class=avatar src="https://avatars.githubusercontent.com/u/20598369?v=4" alt=giacomo-avatar>
<img class=avatar src="https://avatars.githubusercontent.com/u/4855008?v=4" alt=nicolo-avatar>
<img class=avatar src="https://avatars.githubusercontent.com/u/11615611?v=4" alt=nicolas-avatar>
<img class=avatar src="https://avatars.githubusercontent.com/u/62563336?v=4" alt=linda-avatar></p></section><section><h1 id=introduction>Introduction</h1><p>We decided to model the domain of the <a href=https://mambelli.com><em>Mambelli</em></a> cheese factory:<br>a small family business that produces and sells cheese.</p><p>We chose this domain because:</p><ul><li>It is quite complex</li><li>There are domain experts that could help us</li><li>We ‚ù§Ô∏è cheese</li></ul></section><section><section data-shortcode-section><h1 id=domain-modeling>Domain Modeling</h1><img class=stretch src=img/event-storming-session.gif alt="event storming session"></section><section><h2 id=event-storming>Event Storming</h2><img class="stretch no-border" src=img/event-storming.svg alt="event storming diagram"><aside class=notes><p>Descrivi qui i 7 sottodomini e cosa fanno</p></aside></section><section><h2 id=core-domain-chart>Core Domain Chart</h2><img class="stretch no-border" src=img/core-domain-chart.svg alt="core domain chart"><aside class=notes><p>La stima del latte (milk planning) viene al momento fatta a mano basandosi su dati storici e intuito;
√® big bet perch√© porterebbe grandi vantaggi con una predizione accurata del latte da ordinare</p><p>3 sottodomini di supporto diventeranno generici fra qualche anno</p></aside></section><section><h2 id=context-map>Context Map</h2><img class="stretch no-border" src=img/context-map-light.svg alt="context map"><aside class=notes><p>I due sottodomini core (milk planning e production planning) hanno sempre anti-corruption layer quando sono downstream</p><p>Bounded context extra: products, contiene linea di prodotti e ingredienti, shared kernel con tutti:
un cambiamento alla linea di prodotti di Mambelli si deve riflettere su tutti gli altri bounded context,
perch√© se cambia questa anche i processi aziendali devono adattarsi</p></aside></section></section><section><section data-shortcode-section><h1 id=architecture>Architecture</h1><p>The architecture of each bounded context follows the Clean Architecture&rsquo;s structure</p><img class="stretch no-border" src=img/clean-architecture.svg alt="clean architecture"><aside class=notes><ul><li>INVERS DELLE DIP e ISOLAM DOM</li><li>types: concetti dominio mappati 1a1(vedremo come) indipendenti, pochi cambiamenti</li><li>azioni: accedere/usare info dominio (es. creaz pp, prezzat ordine)</li><li>eventi: eventi di dominio esterni o interni(es. ordine ricevuto, piano prod completato)</li><li>terzo layer: meccanismi protez/conversi dati che entrano/escono(fatto con DTO: es. BC)-repository</li><li>ultimo: endpoint (come vedremo), persistenza dati mockata</li></ul></aside></section></section><section><section data-shortcode-section><h1 id=devops>DevOps</h1></section><section><h2 id=dvcs-workflow>DVCS Workflow</h2><p>We adopted a <code>git-flow</code>-like workflow with a <code>beta</code> branch for pre-releases and a <code>main</code> branch for the stable ones</p><div class=mermaid>%%{
init: {
'theme':'base',
'themeVariables': {
'git0': '#ff3c3e',
'git1': '#f9b59c',
'git2': '#8de0d8',
'git3': '#fca55f',
'git4': '#55303e',
'gitBranchLabel0': '#000000',
'gitBranchLabel1': '#000000',
'gitBranchLabel2': '#000000',
'gitBranchLabel3': '#000000',
'gitBranchLabel4': '#ffffff'
}
}
}%%
gitGraph
commit id: "chore: ..."
commit id: "build: ..."
commit id: "chore: ..."
commit id: "ci: ..."
branch beta
commit tag: "1.0.0-beta.1"
branch feat/feature-1
checkout feat/feature-1
commit id: "feat: feature 1"
commit id: "feat: feature 2"
checkout beta
merge feat/feature-1 tag: "1.0.0-beta.2"
branch feat/feature-2
commit id: "feat: feature 3"
checkout beta
merge feat/feature-2 tag: "1.0.0-beta.3"
checkout main
merge beta tag: "1.0.0"
branch fix/fix-2
commit id: "fix: fix1"
commit id: "fix: fix2"
checkout main
merge fix/fix-2 tag: "1.0.1"</div></section><section><h2 id=conventional-commit>Conventional Commit</h2><p>To enforce <code>conventional commit</code> we developed
a <a href=https://github.com/nicolasfara/conventional-commits><em>gradle plugin</em></a> and an
<a href=https://github.com/nicolasfara/sbt-conventional-commits><em>sbt plugin</em></a>.
The plugin is handy since:</p><ul><li>It creates a git hook as soon as the project is imported<br>(one cannot forget to set it up!)</li><li>It can also be configured through ad-hoc plug-in keys</li></ul><aside class=notes><p>Perch√© usare <code>conventional commit</code>?</p><ul><li><p>Determinare automaticamente il version bump</p></li><li><p>Avviare build e publishing del progetto in automatico</p></li><li><p>Generare automaticamenet CHANGELOGs</p></li><li><p>Storia dei commit pi√π facile da capire</p></li><li><p>Husky e commitlint non ci piacevano perch√© uno se ne pu√≤ dimenticare
dato che richiedono intervento manuale</p></li></ul></aside></section><section><h2 id=semantic-release>Semantic Release</h2><p><a href=https://semantic-release.gitbook.io/semantic-release/><code>semantic-release</code></a>
automates the whole package release workflow:</p><ul><li>Determines the next version number</li><li>Generates the release notes</li><li>Publishes the package</li></ul><p>The use of <strong>Conventional Commits</strong> combined with <strong>Semantic Release</strong> helped us to automate the release process</p></section><section><h2 id=quality-assurance>Quality Assurance</h2><p>Code quality is an important aspect, so the following tools have been used:</p><ul><li><a href=https://www.wartremover.org/>Wartremover</a></li><li><a href=https://scalacenter.github.io/scalafix/>Scalafix</a></li><li><a href=https://scalameta.org/scalafmt/>Scalafmt</a></li></ul><p>Each of these tools is used in CI to prevent the merging of bad code</p></section><section><h2 id=continuous-integration-and-deployment>Continuous Integration and Deployment</h2><p>The following workflow is the result of a pipeline optimization that seeks to take full advantage of the parallelism between jobs:</p><div class=mermaid>%%{init: {'theme':'base'}}%%
flowchart LR
SFMT(Scalafmt) --> B
SFX(Scalafix) --> B
WRM(Wartremover) --> B
T(Unit test) --> Cov(Coverage Report)
Cov --> B
A(Documentation site)-->B(Publish)
B --> C(Publish site)</div><p>To simplify the <code>Publish</code> job, the <a href=https://github.com/atedeg/scala-release><code>scala-release</code></a> action was developed</p></section><section><h2 id=project-management>Project Management</h2><ul><li>We first defined a product backlog and biweekly sprint backlogs</li><li>All backlog items are tracked by linked GitHub issues</li><li>Closing PRs and issues automatically advances the project status</li></ul></section></section><section><section data-shortcode-section><h1 id=development-choices>Development Choices</h1></section><section><h2 id=domain-modeling-approach>Domain Modeling Approach</h2><p>All core domain concepts are modelled using simple ADTs to keep
them as simple and adherent to the expert&rsquo;s definition as possible:</p><pre><code class=language-scala data-line-numbers>enum Batch:
  case Aging(id: BatchID, cheeseType: CheeseType, readyFrom: LocalDateTime)
  case ReadyForQualityAssurance(id: BatchID, cheeseType: CheeseType)
</code></pre><p>instead of the possibly confusing:</p><pre><code class=language-scala data-line-numbers>final case class Batch(
  id: BatchID,
  cheeseType: CheeseType,
  isAging: Bool,
  readyFrom: Option[LocalDateTime], // only defined if isAging 
)
</code></pre><aside class=notes><ul><li>La prima esprime chiaramente i possibili stati in cui si pu√≤ trovare un lotto</li><li>Non ci possono essere stati incoerenti</li><li>La definizione √® pi√π semplice e lineare da leggere anche per un esperto di dominio</li></ul></aside></section><section><p>All primitive types are not only wrapped in appropriate value objects but also enriched
with compile-time-checked predicates:</p><pre><code class=language-scala data-line-numbers>type PositiveNumber = Int Refined Positive
final case class InStockQuantity(n: PositiveNumber)
</code></pre><p>instead of:</p><pre><code class=language-scala data-line-numbers>final case class InStockQuantity private(n: Int)
object InStockQuantity:
  def apply(n: Int): Option[InStockQuantity] =
    if n &lt; 0 then None else Some(InStockQuantity(n))
</code></pre><aside class=notes><ul><li>Modellazione pi√π chiara, facile da leggere anche per un esperto di dominio</li><li>Esprime chiaramente delle invarianti importanti a livello di type signature</li><li>Non c&rsquo;√® bisogno di andare a leggere il codice del costruttore</li><li>Meno test da scrivere perch√© non c&rsquo;√® un costruttore la cui implementazione potrebbe
erroneamente cambiare nel tempo</li><li>Pi√π errori catturati compile-time</li></ul></aside></section><section><h2 id=side-effect-encoding-via-monads>Side-effect Encoding via Monads</h2><p>All core domain actions use a monadic encoding of side-effects: all side effects are reified
(using an <a href=https://typelevel.org/cats-mtl/getting-started.html><code>mtl</code></a>-style encoding)
and expressed in the type signature of the function</p><pre><code class=language-scala data-line-numbers=|1|1,5|1,7|>def labelProduct[M[_]: CanRaise[WeightNotInRange]: CanEmit[ProductStocked]: Monad]
  (...): M[LabelledProduct] =
for
  ...
  product &lt;- optionalProduct.ifMissingRaise(WeightNotInRange(...): WeightNotInRange)
  labelledProduct = LabelledProduct(product, AvailableQuantity(1), batch.id)
  _ &lt;- emit(ProductStocked(labelledProduct): ProductStocked)
yield labelledProduct
</code></pre><aside class=notes><ul><li>Modellazione pi√π chiara, isola ed esprime chiaramente i side effect</li><li>DSL monadico per scrivere codice che sia pi√π facilmente comprensibile</li><li>Reificando i side effect diventa molto semplice testare le diverse azioni isolandole fra loro</li></ul></aside></section><section><h2 id=dtos>DTOs</h2><p>DTOs play a fundamental role in transferring data to and from a bounded context.
All the repetitive code needed to generate a <code>DTO</code> instance is automatically generated
taking advantage of Scala 3&rsquo;s metaprogramming and inlining</p><pre><code class=language-scala data-line-numbers>final case class Client(code: ClientCode, name: String, vatNumber: VATNumber)
final case class ClientDTO(code: String, name: String, vatNumber: String)

// Automatic derivation with compile-time checks!
given DTO[Client, ClientDTO] = productTypeDTO
</code></pre></section><section><h2 id=http-api>HTTP API</h2><p>We used the <a href=https://tapir.softwaremill.com/en/latest/>tapir</a> library to define the endpoints.
It proved to be useful in many ways:</p><ul><li>The endpoints are defined declaratively</li><li>All the endpoints definitions are type-checked</li><li>It automatically generates the OpenAPI specification and displays it through Swagger</li></ul><pre><code class=language-scala>// GET order/{order-id}/ddt
val getTransportDocumentEndpoint: PublicEndpoint[String, String, TransportDocumentDTO, Any] =
  endpoint.get
    .in(&quot;order&quot;)
    .in(
      path[String]
        .description(&quot;The ID of the order for which the transport document is requested&quot;)
        .name(&quot;order-id&quot;),
    )
    .in(&quot;ddt&quot;)
    .out(jsonBody[TransportDocumentDTO].description(&quot;The transport document for the given order&quot;))
    .errorOut(stringBody)
</code></pre><aside class=notes><ul><li>implementare in modo dichiarativo e type-safe endpoints</li><li>da questa descrizione genera specifica openAPI e la mostra tramite Swagger UI</li><li>demo con il serverino swagger</li></ul></aside></section><section><h2 id=documentation>Documentation</h2><ul><li>All ubiquitous language concepts are mirrored by a corresponding ADT in the code</li><li>Keeping the code and the ubiquitous language up-to-date can be a difficult task</li><li>The code should be the only source of truth (the code <em>is</em> the ubiquitous language)</li></ul><p>We needed a way to automatically generate documentation pages containing the
ubiquitous language definitions coming from the scaladoc</p><aside class=notes><ul><li>tutti i concetti sono mappati 1:1</li><li>evitare inconsistenze tra codice e documentazione (copia incolla)</li><li>cos√¨ esperto di dominio e programmatori sono allineati</li></ul></aside></section><section><h2 id=ubidoc>Ubidoc</h2><p>A configurable plugin we developed to create markdown tables from ubiquitous language
definitions from the scaladoc</p><pre><code class=language-scala>/**
 * It defines, for each product, the [[StockedQuantity quantity available in stock]].
 */
final case class Stock(...)
/**
 * A quantity of a stocked product, it may also be zero.
 */
final case class StockedQuantity(...)
</code></pre><p>is turned into this table:</p><table><thead><tr><th>Term</th><th>Definition</th></tr></thead><tbody><tr><td>Stock</td><td>It defines, for each product, the <a href=https://atedeg.dev/mdm/dev/atedeg/mdm/restocking/StockedQuantity.html#>quantity available in stock</a>.</td></tr><tr><td>Stocked Quantity</td><td>A quantity of a stocked product, it may also be zero.</td></tr></tbody></table></section></section><section><h1 id=license>License</h1><p>The open licence that best suited our needs was the
<a href=https://www.apache.org/licenses/LICENSE-2.0>Apache Licence 2.0</a>:<br>our codebase could contain refences to the Mambelli trademark
and this licence does not grant permission to use it<br><em>"&mldr;except as required for reasonable and customary use</em><br><em>in describing the origin of the Work&mldr;"</em></p><aside class=notes><ul><li>in una situa reale progetto chiuso perch√© potrebbe segreti industriali</li><li>MARCHIO REGISTRATO</li></ul></aside></section></div></div><script type=text/javascript src=/mdm-slides/reveal-hugo/object-assign.js></script>
<a href=/mdm-slides/reveal-js/css/print/ id=print-location style=display:none></a>
<script type=text/javascript>var printLocationElement=document.getElementById("print-location"),link=document.createElement("link");link.rel="stylesheet",link.type="text/css",link.href=printLocationElement.href+(window.location.search.match(/print-pdf/gi)?"pdf.css":"paper.css"),document.getElementsByTagName("head")[0].appendChild(link)</script><script type=application/json id=reveal-hugo-site-params>{"height":"900","highlight_theme":"solarized-light","theme":"white","width":"1440"}</script><script type=application/json id=reveal-hugo-page-params>{"custom_theme":"custom-theme.scss","custom_theme_compile":"true","custom_theme_options":{"enablesourcemap":true,"targetpath":"css/custom-theme.css"},"slide_number":"c/t","transition":"slide","transition_speed":"fast"}</script><script src=/mdm-slides/reveal-js/js/reveal.js></script>
<script type=text/javascript>function camelize(e){return e&&Object.keys(e).forEach(function(t){newK=t.replace(/(_\w)/g,function(e){return e[1].toUpperCase()}),newK!=t&&(e[newK]=e[t],delete e[t])}),e}var revealHugoDefaults={center:!0,controls:!0,history:!0,progress:!0,transition:"slide"},revealHugoSiteParams=JSON.parse(document.getElementById("reveal-hugo-site-params").innerHTML),revealHugoPageParams=JSON.parse(document.getElementById("reveal-hugo-page-params").innerHTML),options=Object.assign({},camelize(revealHugoDefaults),camelize(revealHugoSiteParams),camelize(revealHugoPageParams));Reveal.initialize(options)</script><script type=text/javascript src=/mdm-slides/reveal-js/plugin/markdown/marked.js></script>
<script type=text/javascript src=/mdm-slides/reveal-js/plugin/markdown/markdown.js></script>
<script type=text/javascript src=/mdm-slides/reveal-js/plugin/highlight/highlight.js></script>
<script type=text/javascript src=/mdm-slides/reveal-js/plugin/zoom-js/zoom.js></script>
<script type=text/javascript src=/mdm-slides/reveal-js/plugin/notes/notes.js></script>
<script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script>
<script>mermaid.initialize({startOnLoad:!1});let render=e=>{let t=e.currentSlide.querySelectorAll(".mermaid");if(!t.length)return;t.forEach(e=>{let t=e.getAttribute("data-processed");t||mermaid.init(void 0,e)})};Reveal.addEventListener("slidechanged",render),Reveal.addEventListener("ready",render)</script><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]},"HTML-CSS":{linebreaks:{automatic:!0}},svg:{fontCache:"global",linebreaks:{automatic:!0}}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js></script></body></html>